---
title: "Hedging-hyperprior"
author: "Steve Simon"
date: "June 19, 2017"
output: html_document
---

Three dimensional plots are tricky. According to the Wikipedia entry on azimuth, "In mathematics, the azimuth angle of a point in cylindrical coordinates or spherical coordinates is the anticlockwise angle between the positive x-axis and the projection of the vector onto the xy-plane." The value of theta is defined as the azimuthal angle according to the help file of persp3D. So, assuming a colatitude (phi) of 0, the default of value of 0 for theta means that you are staring straight down the X-axis, and the value of 90 means that you are staring straight down the Y-axis.


```{r initial-steps}
library(plot3D)
library(rjags)

cycle_fast <- function(g=1001, cmax=1, rep=g) {
  cyc <- seq(0, cmax, length=g)
  return(rep(cyc, times=rep))
}

cycle_slow <- function(g=1001, cmax=1, rep=g) {
  cyc <- seq(0, cmax, length=g)
  return(rep(cyc, each=rep))
}
cycle_fast(3)
cycle_slow(3)

matrix(cycle_fast(3), nrow=3, byrow=TRUE)

calculate_prior <- function(pi, tau, g=21, alpha=4, beta=16, d=1, hp=dens.uniform) {
  v <- dbeta(pi, d+(alpha-d)*tau, d+(beta-d)*tau)*hp(tau)
  # with byrow=TRUE, cycle_slow is the rows (x) and cycle_fast is the columns (y)
  matrix(v, nrow=g, byrow=TRUE)
}

draw_prior <- function(hp=dens.uniform, g=33, alpha=4, beta=16,
                       tau_max=1, d=1, zmax=4.7) {
  tau <- cycle_slow(g, tau_max)
  pi  <- cycle_fast(g)
  d <- calculate_prior(pi, tau, g, alpha, beta, d, hp)
  persp3D(z=d, xlab="tau", ylab="pi",zlab="Density", zlim=c(0, zmax),
    theta=th, phi=ph, colvar=NULL, col="white", border="black",
    bty="u", col.axis="gray90")
  return(d)
}

tau_slice <- function(tau_cut, hp=dens.uniform, g=33, alpha=4, beta=16,
                      tau_max=1, d=1, zmax=4.7) {
  delta <- 1E-2
  tau <- cycle_slow(g, tau_max)
  pi  <- cycle_fast(g)
  d <- calculate_prior(pi, tau, g, alpha, beta, d, hp)
  d[tau < tau_cut-delta] <- NA
  persp3D(z=d, xlab="tau", ylab="pi",zlab="Density", zlim=c(0, zmax),
    theta=th, phi=ph, colvar=NULL, col="white", border="gray90", 
    bty="u", col.axis="gray90")
  d[tau > tau_cut+delta] <- NA
  persp3D(z=d, xlab="tau", ylab="pi",zlab="Density", zlim=c(0, zmax),
    theta=th, phi=ph, colvar=NULL, col="white", border="black", add=TRUE)
  return(d)
}

pi_slice <- function(pi_cut, hp=dens.uniform, g=33, alpha=4, beta=16,
                      tau_max=1, d=1, zmax=4.7) {
  delta <- 1E-2
  tau <- cycle_slow(g, tau_max)
  pi  <- cycle_fast(g)
  d <- calculate_prior(pi, tau, g, alpha, beta, d, hp)
  d[pi > pi_cut+delta] <- NA
  persp3D(z=d, xlab="tau", ylab="pi",zlab="Density", zlim=c(0, zmax),
    theta=th, phi=ph, colvar=NULL, col="white", border="gray90",
    bty="u", col.axis="gray90")
  d[pi < pi_cut-delta] <- NA
  persp3D(z=d, xlab="tau", ylab="pi",zlab="Density", zlim=c(0, zmax),
    theta=th, phi=ph, colvar=NULL, col="white", border="black", add=TRUE)
  return(d)
}

ct <- function(la,sr=0) {
  plot(0:1,0:1,type="n",axes=FALSE,xlab=" ",ylab=" ")
  text(0.5,0.5,la,srt=sr,cex=2)
}

pl2 <- function(y) {
  plot(x,y,type="l",axes=FALSE,xlab=" ",ylab=" ")
  axis(side=1,at=(0:10)/10,cex=2)
}

dens.uniform <- function(tau) {dunif(tau,0.00,1.00)}
dens.beta0510 <- function(tau) {dbeta(tau,0.5,1)}
dens.beta1510 <- function(tau) {dbeta(tau,1.5,1)}

calc_likelihood <- function(pi, x=54, n=60, g=33) {
  v <- dbinom(x, n, pi)
  matrix(v, nrow=g, byrow=TRUE)
}

draw_likelihood <- function(x=54, n=60,
                             g=33, xmax=1) {
  pi <- cycle_fast(g)
  d <- calc_likelihood(pi, x, n, g)
  persp(z=d, theta=th, phi=ph,
        xlab="tau", ylab="pi", zlab="Likelihood",
        zlim=c(0, max(d)))
  return(d)
}
```

```{r draw-fig1}
png(file="plots/fig1.png",width=900,height=300)
layout(matrix(1:12,nrow=2,byrow=TRUE),
       widths=rep(c(2,8),3)/30,heights=c(9,1)/10)
par(mar=c(2.1,2.1,0.6,0.6))
x <- (1:999)/1000
ct("dbeta(x,4,16)",90)
pl2(dbeta(x,4,16))
ct("dbinom(18,60,x)",90)
pl2(dbinom(18,60,x))
ct("dbeta(x,22,58)",90)
pl2(dbeta(x,22,58))
par(mar=c(0.1,2.1,0.1,0.6))
frame()
ct("Prior")
ct("X")
ct("Likelihood")
ct(expression(phantom(0) %prop% phantom(0)))
ct("Posterior")
dev.off()
```

```{r draw-fig2}
png(file="plots/fig2.png",width=900,height=300)
layout(matrix(1:12,nrow=2,byrow=TRUE),
       widths=rep(c(2,8),3)/30,heights=c(9,1)/10)
par(mar=c(2.1,2.1,0.6,0.6))
x <- (1:999)/1000
ct("dbeta(x,4,16)",90)
pl2(dbeta(x,4,16))
ct("dbinom(54,60,x)",90)
pl2(dbinom(54,60,x))
ct("dbeta(x,58,22)",90)
pl2(dbeta(x,58,22))
par(mar=c(0.1,2.1,0.1,0.6))
frame()
ct("Prior")
ct("X")
ct("Likelihood")
ct(expression(phantom(0) %prop% phantom(0)))
ct("Posterior")
dev.off()
```

```{r calculate-bb-nice}
# posterior mean with x=18, n=60
(18+4)/(18+4+42+16)
# posterior 95% credibility interval
qbeta(c(0.025, 0.975), 18+4, 42+16)
# posterior mean with x=18, n=60, but flat prior
(18+1)/(18+1+42+ 1)
# posterior 95% credibility interval with flat prior
qbeta(c(0.025, 0.975), 18+1, 42+ 1)
```

```{r calculate-bb-nasty}
# posterior mean with x=54, n=60
(54+6)/(54+4+6+16)
# posterior 95% credibility interval
qbeta(c(0.025, 0.975), 54+4, 6+16)
# posterior standard deviation
sqrt((54+4)*(6+16)/((54+4+6+16)^2*(54+4+6+16)))
# posterior mean with x=54, n=60, but flat prior
(54+1)/ (54+1+6+1)
# posterior 95% credibility interval with flat prior
qbeta(c(0.025, 0.975), 54+1, 6+1)
# posterior standard deviation
sqrt((54+1)*(6+1)/((54+1+6+1)^2*(54+1+6+1)))
```

```{r draw-table-bb-nice}
library("rjags")
dat.bb <- list(a=4,b=16,x=18,n=60)
mod.bb <- jags.model("jbb.txt",dat.bb)
update(mod.bb,1000)
out.bb <- coda.samples(mod.bb, "pi", 1000)
summary(out.bb)
```

```{r draw-table-bb-nasty}
dat.bb <- list(a=4,b=16,x=54,n=60)
mod.bb <- jags.model("jbb.txt",dat.bb)
update(mod.bb,1000)
out.bb <- coda.samples(mod.bb, "pi", 1000)
summary(out.bb)
```

```{r draw-table-hedge-nasty}
dat.hedge.nasty <- list(a=4,b=16,x=54,n=60)
mod.hedge.nasty <- jags.model("jhedge.txt",dat.hedge.nasty)
update(mod.hedge.nasty,1000)
out.hedge.nasty <- coda.samples(mod.hedge.nasty, c("pi", "tau", "post.n"), 1000)
summary(out.hedge.nasty)
```

```{r draw-table-hedge-nice}
dat.hedge.nice <- list(a=4,b=16,x=18,n=60)
mod.hedge.nice <- jags.model("jhedge.txt",dat.hedge.nice)
update(mod.hedge.nice,1000)
out.hedge.nice <- coda.samples(mod.hedge.nice, c("pi", "tau", "post.n"), 1000)
summary(out.hedge.nice)
```


```{r draw-hedging-surface}
png(file="plots/fig3.png",width=450,height=450)
th=40; ph=10
par(mar=rep(0.6,4))
surf1 <- draw_prior()
dev.off()
```

```{r draw-tau-slices}
png(file="plots/fig5.png",width=450,height=450)
par(mar=rep(0.6,4), mfrow=c(3,3))
for (i in 0:8) {
  surf1 <- tau_slice(i/8)
}
dev.off()
```

```{r draw-pi-slices}
png(file="plots/fig4.png",width=450,height=450)
par(mar=rep(0.6,4), mfrow=c(3,3))
for (i in 8:0) {
  surf1 <- pi_slice(i/8)
}
dev.off()
```

```{r draw-posterior-nasty}
x     <- 54
n     <- 60
g     <- 33
alpha <-  4
beta  <- 16
hp <- dens.uniform
png(file="plots/fig6.png",width=900,height=300)
par(mar=rep(0.6,4))
layout(matrix(1:12,nrow=2,byrow=TRUE),
       widths=rep(c(2,8),3)/30,heights=c(9,1)/10)
frame()
s1 <- draw_prior(hp, g, alpha, beta)
frame()
s2 <- draw_likelihood(x, n, g)
frame()
s3 <- s1*s2
persp(z=s3, theta=th, phi=ph,
  xlab="tau", ylab="pi", zlab="Density")
frame()
ct("Prior")
ct("X")
ct("Likelihood")
ct(expression(phantom(0) %prop% phantom(0)))
ct("Posterior")
dev.off()
```

```{r draw-posterior-nice}
x     <- 18
n     <- 60
g     <- 33
alpha <-  4
beta  <- 16
hp <- dens.uniform
png(file="plots/fig7.png",width=900,height=300)
layout(matrix(1:12,nrow=2,byrow=TRUE),
       widths=rep(c(2,8),3)/30,heights=c(9,1)/10)
par(mar=rep(0.6,4))
frame()
s1 <- draw_prior(hp, g, alpha, beta)
frame()
s2 <- draw_likelihood(x, n, g)
frame()
s3 <- s1*s2
persp(z=s3, theta=th, phi=ph,
  xlab="tau", ylab="pi", zlab="Density")
frame()
ct("Prior")
ct("X")
ct("Likelihood")
ct(expression(phantom(0) %prop% phantom(0)))
ct("Posterior")
dev.off()
```

```{r leftovers, eval=FALSE}
etau <- function(surf,scale=FALSE) {
  stot <- apply(surf,2,sum)
  sprb <- sweep(surf,2,stot,"/")
  tg <- tau.grid(100,rep=1)
  am <- as.vector(tg %*% sprb)
  sf <- ifelse(scale,max(am),1)
  am <- am/sf
  hm <- 1/((1/post.n) %*% sprb)
  par(mar=rep(2.6,4))
  plot(tg,am,type="l",ylim=c(0,1),axes=FALSE,xlab=" ",ylab=" ")
  axis(side=1,at=(0:10)/10)
  axis(side=2,at=(0:4)/4)
  title("E[tau|pi]")
  return(list(x=tg,y=am))
}

png(file="plots/bb15.png",width=600,height=300)
ref0 <- etau(surf1)
box()
dev.off()

png(file="plots/bb16.png",width=600,height=300)
ref1 <- etau(surf1,scale=TRUE)
box()
dev.off()
```

```{r save-everything}
save.image(file="hedge-plots.RData")
```